name: Build Server

on:
    push:
        tags:
            - "v*"  # 触发标签推送

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0  # 确保获取所有历史记录和标签

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Cache Docker layers
              uses: actions/cache@v3
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build Docker image
              run: |
                  docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t ${{ secrets.DOCKER_USERNAME }}/hetu:latest .

            # 获取上一个标签并标记旧版本
            - name: Tag old version
              run: |
                  # 获取最新的tag
                  previous_tag=$(git describe --tags --abbrev=0)
                  echo "Previous tag: $previous_tag"

                  # 为旧版本打标签
                  docker tag ${{ secrets.DOCKER_USERNAME }}/hetu:latest ${{ secrets.DOCKER_USERNAME }}/hetu:$previous_tag

                  # 推送到 Docker Hub
                  docker push ${{ secrets.DOCKER_USERNAME }}/hetu:$previous_tag

            - name: Push Docker image
              run: |
                  # 推送最新的镜像标签
                  docker push ${{ secrets.DOCKER_USERNAME }}/hetu:latest
